# 文件上传功能说明

## 功能概述

法规库现在支持上传PDF和Word文档，系统会自动解析文档内容并提取法规条款。

---

## 支持的文件格式

- **PDF文档**: `.pdf`
- **Word文档**: `.doc`, `.docx`

**文件大小限制**: 10MB

---

## 功能特点

### 1. 前端上传界面

**位置**: 法规库页面（http://localhost:3000/regulations）

**操作流程**:
1. 点击右上角"上传法规"按钮
2. 在弹窗中点击选择文件或拖拽文件
3. 系统会显示文件名和大小
4. 点击"开始上传"按钮
5. 等待解析完成
6. 查看上传结果（成功则显示解析的条款数量）

### 2. 自动解析

**解析能力**:
- 自动识别文档格式（PDF/Word）
- 提取法规标题（从文件名）
- 识别并提取所有"第X条"格式的条款
- 自动清理和格式化条款内容

**解析逻辑**:
- 使用正则表达式匹配"第X条"
- 提取条款编号和完整内容
- 过滤太短或无效的条款
- 去除多余空白字符

### 3. 数据存储

**存储内容**:
- 法规标题
- 源文件名
- 所有提取的条款
- 条款编号和内容

**数据验证**:
- 检查文件格式是否支持
- 检查文件大小是否超限
- 检查法规是否已存在
- 验证是否提取到有效条款

---

## 技术实现

### 前端（frontend/app/regulations/page.tsx）

**核心功能**:
- 文件选择和验证
- 拖拽上传支持
- 上传进度显示
- 结果反馈

**技术要点**:
```typescript
// 文件类型验证
const validTypes = [
    'application/pdf',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/msword'
]

// 文件大小验证
if (file.size > 10 * 1024 * 1024) {
    // 超过10MB
}

// 使用FormData上传
const formData = new FormData()
formData.append('file', selectedFile)
```

### 后端（backend/）

#### 1. 文档解析器（document_parser.py）

**DocumentParser类**:
- `parse_pdf()`: 解析PDF文档
- `parse_word()`: 解析Word文档
- `parse_file()`: 自动选择解析器
- `_extract_clauses()`: 提取条款

**依赖库**:
- `PyPDF2==3.0.1`: PDF解析
- `python-docx==1.1.0`: Word解析

**示例代码**:
```python
from document_parser import DocumentParser

parser = DocumentParser()
title, clauses = parser.parse_file("法规文档.pdf")

print(f"标题: {title}")
print(f"条款数: {len(clauses)}")
```

#### 2. API端点（app.py）

**POST /api/regulations/upload**

**功能**:
- 接收文件上传
- 验证文件格式和大小
- 调用解析器处理
- 将数据存入数据库
- 返回解析结果

**请求示例**:
```bash
curl -X POST "http://localhost:10000/api/regulations/upload" \
     -F "file=@法规文档.pdf"
```

**响应示例**:
```json
{
    "success": true,
    "regulation_id": 7,
    "regulation_title": "法规文档",
    "clause_count": 85,
    "message": "成功导入法规 '法规文档'，共 85 条"
}
```

**错误处理**:
- 400: 文件格式不支持
- 400: 文件大小超限
- 400: 法规已存在
- 400: 未提取到有效条款
- 500: 文档处理失败

---

## 使用场景

### 场景1: 上传新法规PDF

**步骤**:
1. 准备PDF格式的法规文档
2. 访问法规库页面
3. 点击"上传法规"
4. 选择PDF文件
5. 点击"开始上传"
6. 等待解析完成（通常几秒钟）
7. 查看成功提示（显示条款数量）
8. 法规自动出现在列表中

### 场景2: 上传Word文档

**步骤**:
1. 准备.docx或.doc格式的法规文档
2. 按照场景1的步骤操作
3. 系统会自动识别Word格式并解析

### 场景3: 批量导入

**方法**:
- 依次上传多个文件
- 每个文件独立处理
- 系统会自动检查重复

---

## 注意事项

### 1. 文档格式要求

**必须包含**:
- 明确的"第X条"格式
- 中文数字（零一二三四五六七八九十百千）
- 完整的条款内容

**示例格式**:
```
第一条 本法适用于...
第二条 招标投标活动应当遵循...
第三条 依法必须进行招标的项目...
```

### 2. 常见问题

**Q: 上传后显示"未提取到有效条款"？**
A: 检查文档格式是否符合"第X条"模式，确保使用中文数字

**Q: 提示"法规已存在"？**
A: 系统通过标题判断重复，如需重新导入，请先删除旧法规

**Q: 解析的条款数量比文档少？**
A: 解析器会过滤太短或格式不符的条款，这是正常现象

**Q: 支持扫描版PDF吗？**
A: 不支持，需要包含可提取文本的PDF

### 3. 性能考虑

**解析时间**:
- 小文件（<1MB）：1-2秒
- 中等文件（1-5MB）：2-5秒
- 大文件（5-10MB）：5-10秒

**建议**:
- 单个文件不超过10MB
- 避免上传图片扫描版
- 使用文字版PDF效果最好

---

## 测试方法

### 1. 前端测试

```bash
# 启动前端服务
cd frontend
npm run dev

# 访问 http://localhost:3000/regulations
# 点击"上传法规"按钮测试
```

### 2. API测试

```bash
# 使用curl测试
curl -X POST "http://localhost:10000/api/regulations/upload" \
     -F "file=@测试文件.pdf"

# 或使用Python测试脚本
cd backend
python test_upload.py
```

### 3. 解析器测试

```bash
cd backend
python document_parser.py
```

---

## 技术扩展

### 未来可能的改进

1. **OCR支持**: 支持扫描版PDF的文字识别
2. **批量上传**: 一次上传多个文件
3. **格式转换**: 自动转换不同文档格式
4. **智能解析**: 使用AI识别更复杂的条款格式
5. **进度显示**: 实时显示解析进度
6. **预览功能**: 上传前预览解析结果
7. **编辑功能**: 允许手动调整解析结果

---

## 配置文件更新

**requirements.txt**:
```txt
PyPDF2==3.0.1
python-docx==1.1.0
```

**新增文件**:
- `backend/document_parser.py` - 文档解析器
- `backend/test_upload.py` - 测试脚本
- `backend/data/uploads/` - 临时上传目录

**修改文件**:
- `backend/app.py` - 添加上传API端点
- `frontend/app/regulations/page.tsx` - 添加上传界面

---

## 安全考虑

1. **文件类型验证**: 前后端双重验证
2. **文件大小限制**: 防止资源耗尽
3. **临时文件清理**: 处理后立即删除
4. **重复检查**: 避免重复导入
5. **错误处理**: 完善的异常捕获

---

**功能状态**: ✅ 已完成并测试  
**版本**: 1.1.0  
**更新日期**: 2025-12-31

# 审核规则管理功能说明

## 功能概述

审核规则管理页面展示了审核角色、单据类型和法规条款之间的关联关系，使用可视化的关系图帮助理解审核流程。

---

## 功能特点

### 1. 规则列表展示

**列表视图**:
- 按"角色 → 单据类型"分组显示
- 显示每组包含的条款数量
- 支持展开/折叠查看详情

**示例**:
```
商务管理员 → 采购招标/比选/谈判/评审结论建议
  2 条相关法规条款

厂领导 → 采购招标/比选/谈判/评审结论建议
  2 条相关法规条款
```

### 2. 可视化关系图 ⭐

**三列节点布局**:

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  审核角色    │ ──→ │  单据类型    │ ──→ │  相关条款    │
│             │     │             │     │             │
│ 商务管理员   │     │ 采购招标/... │     │   2 条      │
└─────────────┘     └─────────────┘     └─────────────┘
```

**颜色编码**:
- 蓝色：审核角色节点
- 绿色：单据类型节点
- 紫色：条款数量节点
- 箭头：表示流程方向

### 3. 条款详情展示

展开后显示：
- 条款序号
- 所属法规名称
- 条款编号（如：第二十八条）
- 条款完整内容
- 来源标记（example/manual/auto）
- 优先级数值

### 4. 统计信息

底部统计卡片显示：
- **审核规则组**：不同的角色-单据组合数量
- **条款关联**：总的规则关联数量
- **审核角色**：涉及的角色数量

---

## 页面结构

```
审核规则管理
├── 页面标题和描述
├── 规则列表
│   ├── 规则组 1（可展开）
│   │   ├── 头部：角色 → 单据类型
│   │   └── 展开内容
│   │       ├── 关系图（三列节点）
│   │       └── 条款详情列表
│   ├── 规则组 2（可展开）
│   └── ...
└── 统计信息卡片
```

---

## 使用方法

### 访问页面

1. 打开前端应用：http://localhost:3000
2. 点击侧边栏"管理" → "审核规则"
3. 查看规则列表

### 查看关系图

1. 点击任意规则组
2. 规则自动展开
3. 查看三列关系图：
   - 左侧：审核角色（蓝色）
   - 中间：单据类型（绿色）
   - 右侧：条款数量（紫色）
4. 箭头显示数据流向

### 查看条款详情

在关系图下方：
- 每条条款以卡片形式展示
- 显示序号、法规名称、条款编号
- 显示完整条款内容（超过150字自动截断）
- 显示来源和优先级标签

### 折叠规则

再次点击规则头部即可折叠

---

## 数据示例

### 示例规则 1

**角色**: 商务管理员  
**单据类型**: 采购招标/比选/谈判/评审结论建议  
**关联条款**:

1. **中华人民共和国政府采购法 - 第二十八条**
   - 内容：采购人不得将应当以公开招标方式采购的货物或者服务化整为零...
   - 来源：example
   - 优先级：10

2. **中华人民共和国政府采购法 - 第三十八条**
   - 内容：采用竞争性谈判方式采购的，应当遵循下列程序...
   - 来源：example
   - 优先级：10

### 示例规则 2

**角色**: 厂领导  
**单据类型**: 采购招标/比选/谈判/评审结论建议  
**关联条款**:

1. **中华人民共和国政府采购法 - 第三十六条**
   - 内容：在招标采购中，出现下列情形之一的，应予废标...
   - 来源：example
   - 优先级：10

2. **中华人民共和国政府采购法 - 第五十条**
   - 内容：政府采购合同的双方当事人不得擅自变更、中止或者终止合同...
   - 来源：example
   - 优先级：10

---

## 技术实现

### 前端（frontend/app/manage/rules/page.tsx）

**核心功能**:
- 从API获取审核规则
- 按角色和单据类型分组
- 可展开/折叠交互
- 关系图可视化

**关键代码**:
```typescript
// 分组逻辑
function groupRulesByRoleAndDocType(rules: AuditRule[]): GroupedRule[] {
    const groupMap = new Map<string, GroupedRule>()
    
    rules.forEach(rule => {
        const key = `${rule.role.role_name}|${rule.document_type.type_name}`
        // 分组处理...
    })
    
    return Array.from(groupMap.values())
}

// 展开/折叠控制
function toggleExpand(index: number) {
    const newExpanded = new Set(expandedRules)
    if (newExpanded.has(index)) {
        newExpanded.delete(index)
    } else {
        newExpanded.add(index)
    }
    setExpandedRules(newExpanded)
}
```

**关系图实现**:
- 使用CSS Grid三列布局
- Tailwind CSS实现节点样式
- 渐变背景和箭头图标

### 后端（backend/app.py）

**API端点**: `GET /api/audit-rules`

**功能**:
- 查询所有审核规则
- 连接多个表（角色、单据、条款、法规）
- 返回完整的关联信息

**代码示例**:
```python
@app.get("/api/audit-rules")
def get_audit_rules(db: Session = Depends(get_db)):
    rules = (
        db.query(AuditRule)
        .join(AuditorRole, ...)
        .join(DocumentType, ...)
        .join(Clause, ...)
        .join(Regulation, ...)
        .all()
    )
    return [format_rule(rule) for rule in rules]
```

---

## 设计理念

### 1. 可视化优先

使用图形化的方式展示抽象的关联关系：
- 节点代表实体（角色、单据、条款）
- 箭头代表流程方向
- 颜色区分不同类型

### 2. 渐进式展示

- 默认折叠：显示概要信息
- 点击展开：查看详细关系
- 避免信息过载

### 3. 信息层次

```
第一层：规则组概览
  ├─ 角色名称
  ├─ 单据类型
  └─ 条款数量

第二层：关系图
  ├─ 三列节点
  └─ 连接箭头

第三层：条款详情
  ├─ 法规名称
  ├─ 条款编号
  └─ 完整内容
```

---

## 使用场景

### 场景 1：理解审核流程

**需求**: 新员工需要了解审核流程

**操作**:
1. 访问审核规则页面
2. 查看规则列表
3. 展开自己的角色规则
4. 查看关系图理解流程
5. 阅读具体的法规条款

### 场景 2：检查规则完整性

**需求**: 管理员检查规则配置是否完整

**操作**:
1. 查看统计信息
2. 确认角色和规则组数量
3. 逐个展开规则检查
4. 确保每个角色都有对应的条款

### 场景 3：培训材料

**需求**: 制作培训文档

**操作**:
1. 展开所有规则
2. 截图关系图和条款详情
3. 用于培训材料

---

## 交互说明

### 鼠标悬停效果

- 规则组头部：背景变灰
- 展开按钮：显示手型光标

### 点击交互

- 点击规则头部：展开/折叠
- 点击展开图标：展开/折叠
- 展开时平滑过渡动画

### 视觉反馈

- 展开：显示向下箭头 ▼
- 折叠：显示向右箭头 ▶
- 加载：显示旋转动画

---

## 数据流程

```
前端页面
    ↓
调用 getAuditRules()
    ↓
GET /api/audit-rules
    ↓
后端查询数据库
    ↓
多表连接查询
    ↓
返回JSON数据
    ↓
前端分组处理
    ↓
渲染关系图
```

---

## 性能优化

### 1. 数据分组

在前端进行分组，减少渲染复杂度：
```typescript
const grouped = groupRulesByRoleAndDocType(data)
```

### 2. 按需展开

默认折叠所有规则，避免一次性渲染大量内容：
```typescript
const [expandedRules, setExpandedRules] = useState<Set<number>>(new Set())
```

### 3. 条款截断

长文本自动截断为150字：
```typescript
{clause.content.length > 150 
    ? clause.content.substring(0, 150) + '...' 
    : clause.content
}
```

---

## 未来扩展

### 短期

1. **添加规则功能**
   - 选择角色
   - 选择单据类型
   - 选择条款
   - 设置优先级

2. **编辑规则**
   - 修改优先级
   - 更换条款
   - 删除规则

### 中期

3. **规则导出**
   - 导出为Excel
   - 导出为PDF
   - 打印视图

4. **批量管理**
   - 批量添加
   - 批量删除
   - 批量修改优先级

### 长期

5. **智能推荐**
   - 基于AI推荐相关条款
   - 自动匹配规则
   - 优化规则配置

6. **可视化增强**
   - 交互式图表
   - 动态关系图
   - 3D可视化

---

## 常见问题

**Q: 为什么有些规则组没有条款？**
A: 可能还未配置，需要添加规则

**Q: 如何添加新规则？**
A: 目前需要通过数据库或API添加，前端UI开发中

**Q: 条款显示不全怎么办？**
A: 点击查看完整内容（功能待开发）

**Q: 可以导出规则吗？**
A: 导出功能计划中，敬请期待

---

## 更新日志

### v1.1.0 (2025-12-31)

- ✅ 实现审核规则列表展示
- ✅ 添加可视化关系图
- ✅ 支持展开/折叠交互
- ✅ 添加统计信息卡片
- ✅ 使用现有示例数据

---

**功能状态**: ✅ 已完成  
**版本**: 1.1.0  
**更新日期**: 2025-12-31
